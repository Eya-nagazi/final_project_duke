Type.registerNamespace("Common.App.SafeLinks");Common.App.SafeLinks.b=function(n,t,i,r,u){this.IsSafeLinksEnabled=null;this.WebAffinitizedUrl=null;this.PolicyCookie=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.IsSafeLinksEnabled=n;this.WebAffinitizedUrl=t;this.PolicyCookie=i;this.PolicyCookieTTL=r;this.WasServiceDown=u};Common.App.SafeLinks.SafeLinksManager=function(n,t,i,r,u,f){var s,e,a,h;if(this.v=Function.createDelegate(this,this.G),this.w=Function.createDelegate(this,this.H),Diag.a.a(26019598,378,100,"Initializing SafeLinksManager."),this.b=n,this.s=t,this.o=i,Common.App.SafeLinks.SafeLinksManager.b=f,this.q=r?this.b.b("SafeLinksHandlerWebServiceBase"):this.b.b("WebServiceBase"),this.p=this.b.b("SafeLinksHashedUserId"),this.u=this.b.b("SafeLinksWorkloadIdHeaderValue"),this.i=this.b.c("SafeLinksMaxGetPolicyBootRetries",2),this.j=this.b.c("SafeLinksMaxGetPolicyOnLinkClickRetries",1),this.g=this.L(),this.f=this.K(),Diag.a.a(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.g,this.f),this.g&&this.f){var o=this.n(),c=o?o.IsSafeLinksEnabled.toLowerCase():"",l=this.y();Diag.a.a(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",c,l);s=!o||c==="unknown"||o.WasServiceDown||l;e=this.t();e&&(e.set("shouldGetSafeLinksDataFromServer",s.toString()),e.set("isSafeLinksEnabledCacheValue",c.toString()));Common.s.a().recordKpiUsage("SafeLinksGetPolicy",0,"jpittsdirects",e);a=this.b.e("LicensingForSafeLinksIsEnabled")?this.b.a("LicensingForSafeLinksIsEnabled"):!1;a&&u?(this.h=!1,h=this,u.a(function(n){n.a("MsoUrlreputation",!0).then(function(n){return h.h=n,h.h&&s&&h.r(!0),null})})):s&&this.r(!0)}};Common.App.SafeLinks.SafeLinksManager.c=function(n){return n.toLowerCase()!=="false"?!0:!1};Common.App.SafeLinks.SafeLinksManager.prototype={b:null,s:null,u:null,q:null,p:null,o:null,i:0,j:0,d:0,e:0,l:!1,k:!1,c:null,h:!0,g:!1,f:!1,m:null,D:function(){var t=this.q?this.q+"/":"",n=new Common.bD("SafeLinksHandler.ashx");return n.a("app",this.o),this.b.a("SafeLinksUseDebugHeader")&&n.a("action","debug"),String.format("{0}{1}&{2}",t,n.toString(),Common.a.j)},a:function(n){var i,t,r,u,f;return n?(i=this.J(n),Diag.a.a(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",i,this.g,this.f,this.h),!i||!this.g||!this.f||!this.h)?!1:(Common.s.a().recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",null),t=0,f=(u=this.M(r={val:t}),t=r.val,u),Diag.a.a(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",Common.App.SafeLinks.SafeLinksManager.a.toString(t)),!f)?(Common.s.a().recordKpiFailure("SafeLinksNavigations",Common.App.SafeLinks.SafeLinksManager.a.toString(t),t===1,!0,null),!1):(Diag.a.a(26019601,378,50,"Using safelinks to navigate hyperlink"),!this.y())?(this.B(n),!0):(this.c=n,Diag.a.a(24462627,378,50,"Refreshing the cache as policy cookie expired."),this.k=!1,this.r(!1),!0):(Diag.a.a(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1)},J:function(n){var t,i;if(n=n.toLowerCase(),t=this.b.f("SafeLinksUnsupportedProtocols"),t)for(i=0;i<t.length;i++)if(n.startsWith(t[i]))return!1;return!0},r:function(n){var t=this.t(),i;t&&t.set("isOnBootRequest",n.toString());Common.s.a().recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",t);Common.s.a().recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",t);i=this.C("SafeLinksGetPolicy");this.s.a(this.D(),1,null,null,!0,2,this.w,this.v,i,null,!1,null,null,"23",null,!1,null,!1,null);this.k=n;this.l=!0;n?this.d++:this.e++},H:function(n){var u=406,i="",t,r,l,a,v;try{this.k=!1;this.l=!1;var o=n.b.f,s,h,c=(h=this.A(s={val:o}),o=s.val,h),f,y=(f=new Common.bS,f.durationMs=c,f);if(Common.s.a().recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",y),Diag.a.a(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",n.b.c,n.b.a.length,c),n.b.c!==200){i="Unexpected httpStatus: "+n.b.c.toString();return}t=null;try{t=JSON.parse(n.b.a)}catch(p){i="Exception:"+p.toString()+" deserializing response: "+n.b.a;return}if(!t){i="Error when serializing response into SafeLinksData. SafeLinksData is null.";return}if(r=t.IsSafeLinksEnabled,isNullOrUndefined(r)||r.length<=0){i="Invalid isSafeLinksEnabledString";return}if(Diag.a.a(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",r),l=Common.App.SafeLinks.SafeLinksManager.c(r),isNullOrUndefined(t.WebAffinitizedUrl)||t.WebAffinitizedUrl.length<=0){i="Invalid WebAffinitizedUrl";return}if(isNullOrUndefined(t.PolicyCookie)||t.PolicyCookie.length<=0){i="Invalid PolicyCookie";return}if(isNullOrUndefined(t.PolicyCookieTTL)){i="Invalid PolicyCookieTTL";return}var w=t.WebAffinitizedUrl,b=t.PolicyCookie,e=new Date,k=t.PolicyCookieTTL>5?t.PolicyCookieTTL-5:0;e.setMinutes(e.getMinutes()+k);a=e.getTime();v=new Common.App.SafeLinks.b(r,w,b,a,!1);this.z(v);u=n.b.c;this.c&&(l?(this.B(this.c),this.d=0,this.e=0):(Diag.a.a(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),Common.s.a().recordKpiFailure("SafeLinksNavigations",Common.App.SafeLinks.SafeLinksManager.a.toString(1),!0,!0,null),Common.g.e(this.c)),this.c=null)}catch(d){i="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+d.toString()}finally{u!==200&&this.x(u,i)}},G:function(n){var i,t;this.l=!1;i=500;t="";try{var u=n.b.f,f,e,o=(e=this.A(f={val:u}),u=f.val,e),r,s=(r=new Common.bS,r.durationMs=o,r);i=n.b.c;Common.s.a().recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+i.toString(),!1,!0,s);t="Request Failed, Status="+Common.ci.toString(n.b.b)+" Duration: "+o;isNullOrUndefined(n.b.a)||(t+=" ResponseData=",t+=n.b.a.substring(0,Math.min(n.b.a.length,100)))}catch(h){t="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+h.toString()}finally{this.x(i,t)}},x:function(n,t){var r,i,u,f;try{Diag.a.a(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",n,t);this.d<this.i&&this.e<this.j?this.r(this.k):(this.k=!1,Diag.a.a(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.d,this.e,n,t),r=null,i=this.t(),i&&(i.set("HttpStatus",n.toString()),i.set("ErrorMessage",t),r=(u=new Common.bS,u.extendedProperties=i,u)),Common.s.a().recordKpiFailure("SafeLinksGetPolicy","GetPolicyRequestError",!1,!0,r),f=new Common.App.SafeLinks.b("false","","",0,!0),this.z(f),this.c&&(Diag.a.a(26019603,378,50,"Error occured during at-click GetPolicy call, NavigationState = {0}",Common.App.SafeLinks.SafeLinksManager.a.toString(2)),Common.s.a().recordKpiFailure("SafeLinksNavigations",Common.App.SafeLinks.SafeLinksManager.a.toString(2),!1,!0,null),Common.g.e(this.c),this.c=null))}catch(e){Diag.a.a(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",e.toString())}},B:function(n){var i=this.F(),r=this.I(),t={};t.Url=n;t.SafeLinksCookie=i;t.CorrelationId=Common.A.a().a;t.WorkloadId=this.u;t.UserAgentInfo=Common.c.Y()+"|"+this.o;Diag.a.a(23900187,378,50,"Validating hyperlink with request correlation: {0}",t.CorrelationId);Common.g.r(Common.g.f(4),r,t)},L:function(){var n=this.b.b("IsSafeLinksEnabledForUser");return n?Common.App.SafeLinks.SafeLinksManager.c(n):!1},K:function(){var n=this.b.f("SafeLinksDisabledBrowsers");return n&&Common.c.r()&&Array.contains(n,"Electron")?!1:!0},M:function(n){var t,i,r;return(n.val=0,t=this.n(),i=t?t.IsSafeLinksEnabled:"",i!=="")?t.WasServiceDown?(Diag.a.a(51663971,378,50,"Failed to retrieve policy data"),n.val=2,!1):i.toLowerCase()==="false"?(Diag.a.a(51664e3,378,50,"SafeLinks disabled for the user"),n.val=1,!1):Common.App.SafeLinks.SafeLinksManager.c(i):this.l?(n.val=3,Diag.a.a(595079384,378,50,"Currently getting SafeLinks policy"),!1):this.d>=this.i||this.e>=this.j?(n.val=2,Diag.a.a(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.d,this.i,this.e,this.j),!1):(r=this.d+this.e,Diag.a.a(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.i+this.j-r),!0)},F:function(){var n=this.n();return n?n.PolicyCookie:""},I:function(){var n=this.n();return n?n.WebAffinitizedUrl:""},E:function(){var t=new Date,n,i;try{n=this.n();i=n?n.PolicyCookieTTL:0;t.setTime(i)}catch(r){Diag.a.a(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",r)}return t},y:function(){var n=this.E();return!!n&&n.getTime()<Date.now()},n:function(){if(!this.m){var n=Common.Utils.c.a().d(this.p);if(!n||n==="")return null;this.m=JSON.parse(n)}return this.m},z:function(n){if(isNullOrUndefined(n))throw Error.argumentNull("safeLinksData");else if(isNullOrUndefined(n.IsSafeLinksEnabled)||n.IsSafeLinksEnabled.length<=0)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.m=n;n.WasServiceDown||this.N(n)},N:function(n){var t=JSON.stringify(n);Common.Utils.c.a().a(this.p,t)},C:function(n){return isNullOrUndefined(Common.App.SafeLinks.SafeLinksManager.b)?null:Common.App.SafeLinks.SafeLinksManager.b.a("WebServiceCall",n)},A:function(n){if(!isNullOrUndefined(n.val)){var t=n.val.b();return n.val.a(),n.val=null,t}return null},t:function(){try{return new Map}catch(n){return null}}};Common.App.SafeLinks.SafeLinksManager.a=function(){};Common.App.SafeLinks.SafeLinksManager.a.prototype={enabledByPolicy:0,disabledByPolicy:1,disabled_GetPolicyFailure:2,disabled_PendingGetPolicyRequest:3};Common.App.SafeLinks.SafeLinksManager.a.registerEnum("Common.App.SafeLinks.SafeLinksManager.a",!1);Common.App.SafeLinks.c=function(){};Common.App.SafeLinks.c.b=function(n){switch(n){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}};Common.App.SafeLinks.c.a=function(n){switch(n){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Common.App.SafeLinks.b.registerClass("Common.App.SafeLinks.b");Common.App.SafeLinks.SafeLinksManager.registerClass("Common.App.SafeLinks.SafeLinksManager",null,Common.App.SafeLinks.a);Common.App.SafeLinks.SafeLinksManager.b=null;Type.registerNamespace("_Ewa");_Ewa.xI=function(n){_Ewa.xI.initializeBase(this);this.h=n;this.k()};_Ewa.xI.a=function(n){n.b().b(_Ewa.bbW.$$(Common.App.SafeLinks.a),270,new _Ewa.xI(n))};_Ewa.xI.prototype={h:null,b:function(){this.j(this.h.b().a(Common.App.SafeLinks.a,269,!1)||new Common.App.SafeLinks.SafeLinksManager(Common.a.a,Common.a.d,String.format("{0}-{1}",Common.App.SafeLinks.c.b(Common.a.b().a().b()),Common.App.SafeLinks.c.a(Common.a.b().a().l())),!1,null,null))}};_Ewa.xI.registerClass("_Ewa.xI",_Ewa.qm.$$(Common.App.SafeLinks.a));Type.registerNamespace("_Ewa");_Ewa.beD=function(){};_Ewa.beD.a=function(){_Ewa.k.a(function(n){_Ewa.xI.a(n)})};_Ewa.beD.a();